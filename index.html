<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Real Estate CRM</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: { primary: '#5D5CDE' } } } }
  </script>

  <!-- Font Awesome 6 -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <meta name="theme-color" content="#5D5CDE">
  <style>
    .btn { @apply px-3 py-2 rounded-lg text-sm; }
    .btn-primary { @apply bg-primary text-white; }
    .btn-blue { @apply bg-blue-600 text-white; }
    .btn-red { @apply bg-red-600 text-white; }
    .btn-ghost { @apply bg-gray-100 dark:bg-gray-700; }
    .card { @apply bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm; }
    .muted { @apply text-xs text-gray-600 dark:text-gray-400; }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white">
  <!-- Header -->
  <header class="bg-white dark:bg-gray-800 shadow-sm border-b p-4 sticky top-0 z-40">
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-2">
        <i class="fa-solid fa-home text-primary text-xl"></i>
        <h1 class="text-lg font-bold">RealEstate CRM</h1>
      </div>

      <div class="flex items-center gap-2">
        <span id="syncStatus" class="hidden text-xs text-gray-500 dark:text-gray-400 mr-1"></span>
        <button id="darkToggle" class="btn btn-ghost" title="Toggle dark mode">
          <i class="fa-solid fa-moon"></i>
        </button>
        <button onclick="showAddModal()" class="btn btn-primary">
          <i class="fa-solid fa-plus mr-1"></i>Add
        </button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="p-4 pb-28">
    <!-- Counters -->
    <div class="grid grid-cols-2 gap-3 mb-6">
      <div class="card text-center">
        <i class="fa-solid fa-building text-primary text-2xl mb-2"></i>
        <p class="text-2xl font-bold text-primary" id="propertyCount">0</p>
        <p class="muted">Properties</p>
      </div>
      <div class="card text-center">
        <i class="fa-solid fa-users text-blue-500 text-2xl mb-2"></i>
        <p class="text-2xl font-bold text-blue-500" id="contactCount">0</p>
        <p class="muted">Contacts</p>
      </div>
    </div>

    <!-- Properties -->
    <section class="mb-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-bold">Recent Properties</h2>
        <div class="flex gap-2">
          <button class="btn btn-ghost" onclick="exportPropertiesCSV()" title="Export properties CSV">
            <i class="fa-solid fa-file-arrow-down mr-2"></i>Export CSV
          </button>
          <button class="btn btn-ghost" onclick="document.getElementById('importPropsInput').click()" title="Import properties CSV">
            <i class="fa-solid fa-file-arrow-up mr-2"></i>Import CSV
          </button>
          <input id="importPropsInput" type="file" accept=".csv,text/csv" class="hidden" onchange="handleImportProps(this.files[0])">
        </div>
      </div>
      <div id="propertiesList" class="space-y-3">
        <p class="text-gray-500 text-center py-8">No properties yet. Tap + to add one.</p>
      </div>
    </section>

    <!-- Contacts -->
    <section class="mb-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-bold">Recent Contacts</h2>
        <div class="flex gap-2">
          <button class="btn btn-ghost" onclick="exportContactsCSV()" title="Export contacts CSV">
            <i class="fa-solid fa-file-arrow-down mr-2"></i>Export CSV
          </button>
          <button class="btn btn-ghost" onclick="document.getElementById('importContactsInput').click()" title="Import contacts CSV">
            <i class="fa-solid fa-file-arrow-up mr-2"></i>Import CSV
          </button>
          <input id="importContactsInput" type="file" accept=".csv,text/csv" class="hidden" onchange="handleImportContacts(this.files[0])">
        </div>
      </div>
      <div id="contactsList" class="space-y-3">
        <p class="text-gray-500 text-center py-8">No contacts yet. Tap + to add one.</p>
      </div>
    </section>
  </main>

  <!-- Bottom Nav -->
  <nav class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t p-2">
    <div class="flex justify-around">
      <button class="flex flex-col items-center p-2 text-primary">
        <i class="fa-solid fa-chart-line text-xl mb-1"></i>
        <span class="text-xs">Dashboard</span>
      </button>
      <button class="flex flex-col items-center p-2 text-gray-500">
        <i class="fa-solid fa-building text-xl mb-1"></i>
        <span class="text-xs">Properties</span>
      </button>
      <button class="flex flex-col items-center p-2 text-gray-500">
        <i class="fa-solid fa-users text-xl mb-1"></i>
        <span class="text-xs">Contacts</span>
      </button>
      <button class="flex flex-col items-center p-2 text-gray-500">
        <i class="fa-solid fa-calendar text-xl mb-1"></i>
        <span class="text-xs">Calendar</span>
      </button>
    </div>
  </nav>

  <!-- Add chooser -->
  <div id="addModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="card w-full max-w-md mx-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold">Add New</h3>
        <button onclick="hideAddModal()" class="text-gray-500">
          <i class="fa-solid fa-xmark text-xl"></i>
        </button>
      </div>
      <div class="space-y-3">
        <button onclick="showPropertyForm()" class="w-full btn btn-primary">
          <i class="fa-solid fa-building mr-2"></i>Add Property
        </button>
        <button onclick="showContactForm()" class="w-full btn btn-blue">
          <i class="fa-solid fa-user mr-2"></i>Add Contact
        </button>
      </div>
    </div>
  </div>

  <!-- Property form -->
  <div id="propertyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="card w-full max-w-md mx-4 max-h-[80vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold">Add Property</h3>
        <button onclick="hidePropertyForm()" class="text-gray-500">
          <i class="fa-solid fa-xmark text-xl"></i>
        </button>
      </div>
      <form onsubmit="submitProperty(event)" class="space-y-4">
        <input type="text" id="propAddress" placeholder="Property Address" required
               class="w-full px-4 py-3 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600">
        <select id="propType" required
                class="w-full px-4 py-3 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600">
          <option value="">Property Type</option>
          <option value="house">House</option>
          <option value="apartment">Apartment</option>
          <option value="townhouse">Townhouse</option>
          <option value="unit">Unit</option>
        </select>
        <div class="grid grid-cols-3 gap-2">
          <input type="number" id="propBeds" placeholder="Beds" min="0" step="1" required
                 class="px-3 py-3 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600">
          <input type="number" id="propBaths" placeholder="Baths" min="0" step="1" required
                 class="px-3 py-3 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600">
          <input type="number" id="propCars" placeholder="Cars" min="0" step="1" required
                 class="px-3 py-3 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600">
        </div>
        <input type="text" id="propPrice" inputmode="decimal" placeholder="Price e.g. 750000" required
               class="w-full px-4 py-3 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600">
        <button type="submit" class="w-full btn btn-primary">Add Property</button>
      </form>
    </div>
  </div>

  <!-- Contact form -->
  <div id="contactModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="card w-full max-w-md mx-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold">Add Contact</h3>
        <button onclick="hideContactForm()" class="text-gray-500">
          <i class="fa-solid fa-xmark text-xl"></i>
        </button>
      </div>
      <form onsubmit="submitContact(event)" class="space-y-4">
        <input type="text" id="contactName" placeholder="Full Name" required
               class="w-full px-4 py-3 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600">
        <input type="email" id="contactEmail" placeholder="Email"
               class="w-full px-4 py-3 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600">
        <input type="tel" id="contactPhone" placeholder="Phone"
               class="w-full px-4 py-3 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600">
        <select id="contactType" required
                class="w-full px-4 py-3 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600">
          <option value="">Contact Type</option>
          <option value="buyer">Buyer</option>
          <option value="seller">Seller</option>
          <option value="tenant">Tenant</option>
          <option value="investor">Investor</option>
        </select>
        <button type="submit" class="w-full btn btn-blue">Add Contact</button>
      </form>
    </div>
  </div>

  <!-- ===== Core App Script (localStorage + CSV + UI) ===== -->
  <script>
    // Dark mode
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const savedDark = localStorage.getItem('crm_dark');
    if ((savedDark === '1') || (savedDark === null && prefersDark)) {
      document.documentElement.classList.add('dark');
    }
    document.getElementById('darkToggle').addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
      localStorage.setItem('crm_dark', document.documentElement.classList.contains('dark') ? '1' : '0');
    });

    // Data
    let properties = JSON.parse(localStorage.getItem('properties') || '[]');
    let contacts   = JSON.parse(localStorage.getItem('contacts')   || '[]');
    let editingPropertyId = null;
    let editingContactId  = null;

    // Utils
    const esc = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const fmtAUD = new Intl.NumberFormat('en-AU', { style: 'currency', currency: 'AUD' });
    const toMoney = v => {
      const n = Number(String(v).replace(/[^0-9.]/g,''));
      return isNaN(n) ? '' : fmtAUD.format(n);
    };
    const statusEl = document.getElementById('syncStatus');
    const setStatus = (txt) => { statusEl.textContent = txt; statusEl.classList.remove('hidden'); setTimeout(()=>statusEl.classList.add('hidden'), 5000); };

    // CSV helpers
    function escapeCSV(val) {
      if (val === null || val === undefined) return '';
      const s = String(val);
      if (/[",\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
      return s;
    }
    function arrayToCSV(rows) { return rows.map(r => r.map(escapeCSV).join(',')).join('\n'); }
    function parseCSV(text) {
      const rows = []; let row = [], cur = '', inQ = false;
      for (let i=0;i<text.length;i++){ const ch=text[i], nx=text[i+1];
        if(inQ){ if(ch==='"'&&nx==='"'){cur+='"';i++;} else if(ch==='"'){inQ=false;} else {cur+=ch;} }
        else { if(ch==='"'){inQ=true;} else if(ch===','){row.push(cur);cur='';}
               else if(ch==='\n'||ch==='\r'){ if(ch==='\r'&&nx==='\n') i++; row.push(cur); rows.push(row); row=[]; cur='';}
               else {cur+=ch;} }
      }
      if(cur.length||row.length){ row.push(cur); rows.push(row); }
      return rows;
    }

    // Modals
    function showAddModal(){ const m=document.getElementById('addModal'); m.classList.remove('hidden'); m.classList.add('flex'); }
    function hideAddModal(){ const m=document.getElementById('addModal'); m.classList.add('hidden'); m.classList.remove('flex'); }

    function showPropertyForm(id=null){
      hideAddModal(); editingPropertyId=id;
      const modal=document.getElementById('propertyModal'); modal.classList.remove('hidden'); modal.classList.add('flex');
      const btn=modal.querySelector('button[type="submit"]'); const title=modal.querySelector('h3');
      if(id){ const p=properties.find(x=>x.id===id);
        propAddress.value=p.address; propType.value=p.type; propBeds.value=p.bedrooms; propBaths.value=p.bathrooms; propCars.value=p.carSpaces; propPrice.value=p.price;
        btn.textContent='Save changes'; title.textContent='Edit Property';
      } else { propAddress.value=''; propType.value=''; propBeds.value=''; propBaths.value=''; propCars.value=''; propPrice.value='';
        btn.textContent='Add Property'; title.textContent='Add Property'; }
    }
    function hidePropertyForm(){ const m=document.getElementById('propertyModal'); m.classList.add('hidden'); m.classList.remove('flex'); editingPropertyId=null; }

    function showContactForm(id=null){
      hideAddModal(); editingContactId=id;
      const modal=document.getElementById('contactModal'); modal.classList.remove('hidden'); modal.classList.add('flex');
      const btn=modal.querySelector('button[type="submit"]'); const title=modal.querySelector('h3');
      if(id){ const c=contacts.find(x=>x.id===id);
        contactName.value=c.name||''; contactEmail.value=c.email||''; contactPhone.value=c.phone||''; contactType.value=c.type||'';
        btn.textContent='Save changes'; title.textContent='Edit Contact';
      } else { contactName.value=''; contactEmail.value=''; contactPhone.value=''; contactType.value='';
        btn.textContent='Add Contact'; title.textContent='Add Contact'; }
    }
    function hideContactForm(){ const m=document.getElementById('contactModal'); m.classList.add('hidden'); m.classList.remove('flex'); editingContactId=null; }

    // Submit handlers
    function submitProperty(e){
      e.preventDefault();
      const payload={ address:propAddress.value, type:propType.value, bedrooms:propBeds.value, bathrooms:propBaths.value, carSpaces:propCars.value, price:propPrice.value };
      if(editingPropertyId){ properties=properties.map(p=>p.id===editingPropertyId?{...p,...payload}:p); showNotification('Property updated'); }
      else { properties.push({ id:Date.now(), ...payload, createdAt:new Date().toLocaleDateString() }); showNotification('Property added'); }
      localStorage.setItem('properties', JSON.stringify(properties));
      renderProperties(); updateCounts(); hidePropertyForm(); e.target.reset(); editingPropertyId=null;
    }
    function submitContact(e){
      e.preventDefault();
      const payload={ name:contactName.value, email:contactEmail.value, phone:contactPhone.value, type:contactType.value };
      if(editingContactId){ contacts=contacts.map(c=>c.id===editingContactId?{...c,...payload}:c); showNotification('Contact updated'); }
      else { contacts.push({ id:Date.now(), ...payload, createdAt:new Date().toLocaleDateString() }); showNotification('Contact added'); }
      localStorage.setItem('contacts', JSON.stringify(contacts));
      renderContacts(); updateCounts(); hideContactForm(); e.target.reset(); editingContactId=null;
    }

    // Delete
    function deleteProperty(id){ properties=properties.filter(p=>p.id!==id); localStorage.setItem('properties', JSON.stringify(properties)); renderProperties(); updateCounts(); showNotification('Property deleted'); }
    function deleteContact(id){ contacts=contacts.filter(c=>c.id!==id); localStorage.setItem('contacts', JSON.stringify(contacts)); renderContacts(); updateCounts(); showNotification('Contact deleted'); }

    // Renderers
    function renderProperties(){
      const container=document.getElementById('propertiesList');
      if(!properties.length){ container.innerHTML='<p class="text-gray-500 text-center py-8">No properties yet. Tap + to add one.</p>'; return; }
      container.innerHTML = properties.slice(-50).reverse().map(p=>`
        <div class="card">
          <div class="flex justify-between items-start mb-2">
            <h3 class="font-semibold">${esc(p.address)}</h3>
            <span class="text-xs bg-primary text-white px-2 py-1 rounded">${esc(p.type)}</span>
          </div>
          <div class="flex items-center space-x-4 text-sm text-gray-600 dark:text-gray-400 mb-2">
            <span><i class="fa-solid fa-bed mr-1"></i>${esc(p.bedrooms)}</span>
            <span><i class="fa-solid fa-bath mr-1"></i>${esc(p.bathrooms)}</span>
            <span><i class="fa-solid fa-car mr-1"></i>${esc(p.carSpaces)}</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="font-bold text-primary">${toMoney(p.price) || esc(p.price)}</span>
            <span class="text-xs text-gray-500">${esc(p.createdAt||'')}</span>
          </div>
          <div class="flex gap-2 mt-3">
            <button class="btn btn-blue" onclick="showPropertyForm(${p.id})">Edit</button>
            <button class="btn btn-red" onclick="deleteProperty(${p.id})">Delete</button>
          </div>
        </div>
      `).join('');
    }
    function renderContacts(){
      const container=document.getElementById('contactsList');
      if(!contacts.length){ container.innerHTML='<p class="text-gray-500 text-center py-8">No contacts yet. Tap + to add one.</p>'; return; }
      container.innerHTML = contacts.slice(-50).reverse().map(c=>`
        <div class="card">
          <div class="flex justify-between items-start mb-2">
            <h3 class="font-semibold">${esc(c.name)}</h3>
            <span class="text-xs bg-blue-500 text-white px-2 py-1 rounded">${esc(c.type)}</span>
          </div>
          <div class="space-y-1 text-sm text-gray-600 dark:text-gray-400">
            ${c.email ? `<p><i class="fa-solid fa-envelope mr-2"></i>${esc(c.email)}</p>` : ''}
            ${c.phone ? `<p><i class="fa-solid fa-phone mr-2"></i>${esc(c.phone)}</p>` : ''}
          </div>
          <div class="flex justify-between items-center mt-2">
            <span class="text-xs text-gray-500">${esc(c.createdAt||'')}</span>
            <div class="flex gap-2">
              <button class="btn btn-blue" onclick="showContactForm(${c.id})">Edit</button>
              <button class="btn btn-red" onclick="deleteContact(${c.id})">Delete</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Counts + toast
    function updateCounts(){ propertyCount.textContent=properties.length; contactCount.textContent=contacts.length; }
    function showNotification(message, color='bg-green-500'){
      const n=document.createElement('div'); n.className=`fixed top-4 right-4 ${color} text-white px-4 py-2 rounded-lg z-50 shadow`; n.textContent=message;
      document.body.appendChild(n); setTimeout(()=>n.remove(), 2500);
    }

    // CSV export/import
    function exportPropertiesCSV(){
      const headers=['id','address','type','bedrooms','bathrooms','carspaces','price','createdat'];
      const rows=[headers].concat(properties.map(p=>[p.id,p.address,p.type,p.bedrooms,p.bathrooms,p.carSpaces,p.price,p.createdAt||'']));
      downloadFile('properties.csv', arrayToCSV(rows));
    }
    function exportContactsCSV(){
      const headers=['id','name','email','phone','type','createdat'];
      const rows=[headers].concat(contacts.map(c=>[c.id,c.name,c.email||'',c.phone||'',c.type,c.createdAt||'']));
      downloadFile('contacts.csv', arrayToCSV(rows));
    }
    function downloadFile(filename, text){
      const blob=new Blob([text], {type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},0);
    }
    function handleImportProps(file){
      if(!file) return; const r=new FileReader();
      r.onload=()=>{ try{
          const rows=parseCSV(r.result.trim()); if(!rows.length) throw new Error('Empty CSV');
          const header=rows.shift().map(h=>h.toLowerCase()); const idx=n=>header.indexOf(n);
          const need=['id','address','type','bedrooms','bathrooms','carspaces','price','createdat']; const miss=need.filter(k=>idx(k)===-1);
          if(miss.length) throw new Error('Missing columns: '+miss.join(', '));
          const imported=rows.map(v=>({ id:Number(v[idx('id')])||Date.now()+Math.floor(Math.random()*1000), address:v[idx('address')]||'', type:v[idx('type')]||'', bedrooms:v[idx('bedrooms')]||'', bathrooms:v[idx('bathrooms')]||'', carSpaces:v[idx('carspaces')]||'', price:v[idx('price')]||'', createdAt:v[idx('createdat')]||'' }));
          const map=new Map(properties.map(p=>[p.id,p])); imported.forEach(p=>map.set(p.id,{...(map.get(p.id)||{}),...p})); properties=[...map.values()];
          localStorage.setItem('properties', JSON.stringify(properties)); renderProperties(); updateCounts(); showNotification('Properties imported');
        }catch(e){ console.error(e); showNotification('Import failed. Check CSV columns.','bg-red-600'); }
        finally{ document.getElementById('importPropsInput').value=''; }
      }; r.readAsText(file);
    }
    function handleImportContacts(file){
      if(!file) return; const r=new FileReader();
      r.onload=()=>{ try{
          const rows=parseCSV(r.result.trim()); if(!rows.length) throw new Error('Empty CSV');
          const header=rows.shift().map(h=>h.toLowerCase()); const idx=n=>header.indexOf(n);
          const need=['id','name','email','phone','type','createdat']; const miss=need.filter(k=>idx(k)===-1);
          if(miss.length) throw new Error('Missing columns: '+miss.join(', '));
          const imported=rows.map(v=>({ id:Number(v[idx('id')])||Date.now()+Math.floor(Math.random()*1000), name:v[idx('name')]||'', email:v[idx('email')]||'', phone:v[idx('phone')]||'', type:v[idx('type')]||'', createdAt:v[idx('createdat')]||'' }));
          const map=new Map(contacts.map(c=>[c.id,c])); imported.forEach(c=>map.set(c.id,{...(map.get(c.id)||{}),...c})); contacts=[...map.values()];
          localStorage.setItem('contacts', JSON.stringify(contacts)); renderContacts(); updateCounts(); showNotification('Contacts imported');
        }catch(e){ console.error(e); showNotification('Import failed. Check CSV columns.','bg-red-600'); }
        finally{ document.getElementById('importContactsInput').value=''; }
      }; r.readAsText(file);
    }

    // Initial render
    renderProperties(); renderContacts(); updateCounts();
  </script>

  <!-- ===== Google API loader ===== -->
  <script src="https://apis.google.com/js/api.js"></script>

  <!-- ===== Google Sheets Sync (OAuth + read/write) ===== -->
  <script>
    /* === CONFIG (yours) === */
    const GAPI_API_KEY   = 'AIzaSyCX7yThc3WManWS2EJcc0zkKa6o01T1dec';
    const GAPI_CLIENT_ID = '836099334681-tmb272ie85u0qdb080nb97bvcgtvuvvid.apps.googleusercontent.com';
    const SHEET_ID       = '1Oumn0bFkkHvRrETlNEi4u4eM63DPfkkRuwE05gpWdFM';
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
    const DISCOVERY_DOCS = ['https://sheets.googleapis.com/$discovery/rest?version=v4'];

    // Add Sign in / Sync buttons to header
    (function addSyncButtons(){
      const hdr = document.querySelector('header .flex.items-center.justify-between');
      if (!hdr) return;
      const right = hdr.lastElementChild;

      const wrap = document.createElement('div');
      wrap.className = 'flex items-center gap-2';

      const signBtn = document.createElement('button');
      signBtn.id = 'gSignBtn';
      signBtn.className = 'btn btn-ghost';
      signBtn.textContent = 'Sign in';
      wrap.appendChild(signBtn);

      const pullBtn = document.createElement('button');
      pullBtn.id = 'pullBtn';
      pullBtn.className = 'btn btn-ghost';
      pullBtn.textContent = 'Sync ↓';
      pullBtn.disabled = true;
      wrap.appendChild(pullBtn);

      const pushBtn = document.createElement('button');
      pushBtn.id = 'pushBtn';
      pushBtn.className = 'btn btn-ghost';
      pushBtn.textContent = 'Sync ↑';
      pushBtn.disabled = true;
      wrap.appendChild(pushBtn);

      right.prepend(wrap);
    })();

    // Google API init
    function gapiInit() {
      gapi.load('client:auth2', async () => {
        await gapi.client.init({
          apiKey: GAPI_API_KEY,
          clientId: GAPI_CLIENT_ID,
          discoveryDocs: DISCOVERY_DOCS,
          scope: SCOPES
        });

        const auth    = gapi.auth2.getAuthInstance();
        const signBtn = document.getElementById('gSignBtn');
        const pullBtn = document.getElementById('pullBtn');
        const pushBtn = document.getElementById('pushBtn');

        function setAuthUI(signedIn){
          if (signBtn) signBtn.textContent = signedIn ? 'Sign out' : 'Sign in';
          if (pullBtn) pullBtn.disabled = !signedIn;
          if (pushBtn) pushBtn.disabled = !signedIn;
        }

        auth.isSignedIn.listen(setAuthUI);
        setAuthUI(auth.isSignedIn.get());

        if (signBtn) signBtn.onclick = () => auth.isSignedIn.get() ? auth.signOut() : auth.signIn();

        if (pullBtn) {
          pullBtn.onclick = async () => {
            try {
              setStatus('Syncing ↓ from Sheets…');
              const props = await readSheet('Properties!A2:H');
              const cons  = await readSheet('Contacts!A2:F');
              properties = (props || []).map(r => ({
                id: Number(r[0]) || Date.now() + Math.floor(Math.random()*1000),
                address: r[1] || '', type: r[2] || '',
                bedrooms: r[3] || '', bathrooms: r[4] || '',
                carSpaces: r[5] || '', price: r[6] || '',
                createdAt: r[7] || ''
              }));
              contacts = (cons || []).map(r => ({
                id: Number(r[0]) || Date.now() + Math.floor(Math.random()*1000),
                name: r[1] || '', email: r[2] || '', phone: r[3] || '',
                type: r[4] || '', createdAt: r[5] || ''
              }));
              localStorage.setItem('properties', JSON.stringify(properties));
              localStorage.setItem('contacts', JSON.stringify(contacts));
              renderProperties(); renderContacts(); updateCounts();
              showNotification('Pulled from Google Sheets');
              setStatus('Synced just now');
            } catch (e) {
              console.error(e);
              showNotification('Pull failed (Sheets)', 'bg-red-600');
              setStatus('Sync error');
            }
          };
        }

        if (pushBtn) {
          pushBtn.onclick = async () => {
            try {
              setStatus('Syncing ↑ to Sheets…');
              const propValues = (properties || []).map(p => [
                p.id, p.address || '', p.type || '', p.bedrooms || '',
                p.bathrooms || '', p.carSpaces || '', p.price || '', p.createdAt || ''
              ]);
              const conValues = (contacts || []).map(c => [
                c.id, c.name || '', c.email || '', c.phone || '', c.type || '', c.createdAt || ''
              ]);
              await clearRange('Properties!A2:H');
              await clearRange('Contacts!A2:F');
              if (propValues.length) await writeSheet('Properties!A2', propValues);
              if (conValues.length)  await writeSheet('Contacts!A2',  conValues);
              showNotification('Pushed to Google Sheets');
              setStatus('Synced just now');
            } catch (e) {
              console.error(e);
              showNotification('Push failed (Sheets)', 'bg-red-600');
              setStatus('Sync error');
            }
          };
        }
      });
    }
    gapiInit();

    // Sheets helpers
    async function readSheet(rangeA1){
      const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SHEET_ID, range: rangeA1 });
      return res.result.values || [];
    }
    async function writeSheet(rangeA1, values){
      return gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: SHEET_ID, range: rangeA1, valueInputOption: 'RAW', resource: { values }
      });
    }
    async function clearRange(rangeA1){
      return gapi.client.sheets.spreadsheets.values.clear({ spreadsheetId: SHEET_ID, range: rangeA1 });
    }
  </script>
</body>
</html>
