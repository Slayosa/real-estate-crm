<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Real Estate CRM</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: { primary: '#5D5CDE' } } } }
  </script>

  <!-- Font Awesome 6 -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <meta name="theme-color" content="#5D5CDE">
  <style>
    .btn { @apply px-3 py-2 rounded-lg text-sm; }
    .btn-primary { @apply bg-primary text-white; }
    .btn-blue { @apply bg-blue-600 text-white; }
    .btn-red { @apply bg-red-600 text-white; }
    .btn-ghost { @apply bg-gray-100 dark:bg-gray-700; }
    .card { @apply bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm; }
    .muted { @apply text-xs text-gray-600 dark:text-gray-400; }
    .tab-active { @apply text-primary; }
    .badge { @apply text-[11px] px-2 py-0.5 rounded; }
    .badge-green { @apply bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-100; }
    .badge-orange { @apply bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-100; }
    .badge-gray { @apply bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-100; }
    .badge-blue { @apply bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-100; }
    .badge-purple { @apply bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-100; }
    .badge-red { @apply bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-100; }
    .cal-grid { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); gap: .5rem; }
    .cal-cell { @apply border rounded p-2 min-h-[80px] bg-white dark:bg-gray-800; }
    .cal-today { @apply ring-2 ring-primary; }
    .cal-event { @apply text-[11px] mt-1 px-1 py-0.5 rounded bg-primary/10 text-primary; }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white">
  <!-- Header -->
  <header class="bg-white dark:bg-gray-800 shadow-sm border-b p-4 sticky top-0 z-40">
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-2">
        <i class="fa-solid fa-home text-primary text-xl"></i>
        <h1 class="text-lg font-bold">RealEstate CRM</h1>
      </div>

      <div class="flex items-center gap-2">
        <!-- Search -->
        <div class="hidden md:flex items-center">
          <input id="globalSearch" type="search" placeholder="Search…" class="px-3 py-2 rounded-lg text-sm bg-gray-100 dark:bg-gray-700 outline-none">
        </div>

        <!-- Sort dropdowns -->
        <select id="propSort" class="hidden md:block px-2 py-2 rounded-lg text-sm bg-gray-100 dark:bg-gray-700">
          <option value="newest">Props: Newest</option>
          <option value="price">Props: Price</option>
          <option value="beds">Props: Beds</option>
        </select>
        <select id="contactSort" class="hidden md:block px-2 py-2 rounded-lg text-sm bg-gray-100 dark:bg-gray-700">
          <option value="newest">Contacts: Newest</option>
          <option value="name">Contacts: Name</option>
        </select>

        <span id="syncStatus" class="hidden text-xs text-gray-500 dark:text-gray-400 mr-1"></span>
        <button id="darkToggle" class="btn btn-ghost" title="Toggle dark mode">
          <i class="fa-solid fa-moon"></i>
        </button>
        <button onclick="showAddModal()" class="btn btn-primary">
          <i class="fa-solid fa-plus mr-1"></i>Add
        </button>
      </div>
    </div>
    <!-- Mobile filters -->
    <div class="mt-3 flex md:hidden gap-2">
      <input id="globalSearchMobile" type="search" placeholder="Search…" class="flex-1 px-3 py-2 rounded-lg text-sm bg-gray-100 dark:bg-gray-700 outline-none">
      <select id="propSortMobile" class="px-2 py-2 rounded-lg text-sm bg-gray-100 dark:bg-gray-700">
        <option value="newest">P:New</option>
        <option value="price">P:$</option>
        <option value="beds">P:Beds</option>
      </select>
      <select id="contactSortMobile" class="px-2 py-2 rounded-lg text-sm bg-gray-100 dark:bg-gray-700">
        <option value="newest">C:New</option>
        <option value="name">C:Name</option>
      </select>
    </div>
  </header>

  <!-- Main -->
  <main class="p-4 pb-28">
    <!-- DASHBOARD -->
    <section id="dashboardSection">
      <div class="grid grid-cols-2 gap-3 mb-6">
        <div class="card text-center">
          <i class="fa-solid fa-building text-primary text-2xl mb-2"></i>
          <p class="text-2xl font-bold text-primary" id="propertyCount">0</p>
          <p class="muted">Properties</p>
        </div>
        <div class="card text-center">
          <i class="fa-solid fa-users text-blue-500 text-2xl mb-2"></i>
          <p class="text-2xl font-bold text-blue-500" id="contactCount">0</p>
          <p class="muted">Contacts</p>
        </div>
      </div>

      <!-- Properties -->
      <section id="propertiesSection" class="mb-6">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-bold">Recent Properties</h2>
          <div class="flex gap-2">
            <button class="btn btn-ghost" onclick="exportPropertiesCSV()" title="Export properties CSV">
              <i class="fa-solid fa-file-arrow-down mr-2"></i>Export CSV
            </button>
            <button class="btn btn-ghost" onclick="document.getElementById('importPropsInput').click()" title="Import properties CSV">
              <i class="fa-solid fa-file-arrow-up mr-2"></i>Import CSV
            </button>
            <button class="btn btn-ghost" onclick="toggleTrashView('properties')">
              <i class="fa-solid fa-trash mr-2"></i>Trash
            </button>
            <input id="importPropsInput" type="file" accept=".csv,text/csv" class="hidden" onchange="handleImportProps(this.files[0])">
          </div>
        </div>
        <div id="propertiesList" class="space-y-3">
          <p class="text-gray-500 text-center py-8">No properties yet. Tap + to add one.</p>
        </div>
      </section>

      <!-- Contacts -->
      <section id="contactsSection" class="mb-6">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-bold">Recent Contacts</h2>
          <div class="flex gap-2">
            <button class="btn btn-ghost" onclick="exportContactsCSV()" title="Export contacts CSV">
              <i class="fa-solid fa-file-arrow-down mr-2"></i>Export CSV
            </button>
            <button class="btn btn-ghost" onclick="document.getElementById('importContactsInput').click()" title="Import contacts CSV">
              <i class="fa-solid fa-file-arrow-up mr-2"></i>Import CSV
            </button>
            <button class="btn btn-ghost" onclick="toggleTrashView('contacts')">
              <i class="fa-solid fa-trash mr-2"></i>Trash
            </button>
            <input id="importContactsInput" type="file" accept=".csv,text/csv" class="hidden" onchange="handleImportContacts(this.files[0])">
          </div>
        </div>
        <div id="contactsList" class="space-y-3">
          <p class="text-gray-500 text-center py-8">No contacts yet. Tap + to add one.</p>
        </div>
      </section>
    </section>

    <!-- PROPERTIES ONLY -->
    <section id="onlyProperties" class="hidden">
      <h2 class="text-lg font-bold mb-3">All Properties</h2>
      <div id="propertiesListOnly" class="space-y-3"></div>
    </section>

    <!-- CONTACTS ONLY -->
    <section id="onlyContacts" class="hidden">
      <h2 class="text-lg font-bold mb-3">All Contacts</h2>
      <div id="contactsListOnly" class="space-y-3"></div>
    </section>

    <!-- CALENDAR -->
    <section id="calendarSection" class="hidden">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-bold">Calendar</h2>
        <div class="flex items-center gap-2">
          <button class="btn btn-ghost" onclick="prevMonth()"><i class="fa-solid fa-chevron-left"></i></button>
          <div class="text-sm" id="calTitle">Month YYYY</div>
          <button class="btn btn-ghost" onclick="nextMonth()"><i class="fa-solid fa-chevron-right"></i></button>
          <button class="btn btn-ghost" onclick="goToday()">Today</button>
          <button class="btn btn-primary" onclick="openEventModal()">+ Event</button>
        </div>
      </div>
      <div class="card mb-2">
        <div class="grid grid-cols-7 gap-2 text-center text-xs text-gray-600 dark:text-gray-400">
          <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
        </div>
      </div>
      <div id="calGrid" class="cal-grid"></div>
    </section>

    <!-- TRASH -->
    <section id="trashSection" class="hidden">
      <h2 class="text-lg font-bold mb-3">Trash</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <h3 class="font-semibold mb-2">Properties in Trash</h3>
          <div id="trashProps" class="space-y-3"></div>
        </div>
        <div>
          <h3 class="font-semibold mb-2">Contacts in Trash</h3>
          <div id="trashContacts" class="space-y-3"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Bottom Nav -->
  <nav class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t p-2">
    <div class="flex justify-around">
      <button id="navDashboard" class="flex flex-col items-center p-2 tab-active">
        <i class="fa-solid fa-chart-line text-xl mb-1"></i>
        <span class="text-xs">Dashboard</span>
      </button>
      <button id="navProperties" class="flex flex-col items-center p-2">
        <i class="fa-solid fa-building text-xl mb-1"></i>
        <span class="text-xs">Properties</span>
      </button>
      <button id="navContacts" class="flex flex-col items-center p-2">
        <i class="fa-solid fa-users text-xl mb-1"></i>
        <span class="text-xs">Contacts</span>
      </button>
      <button id="navCalendar" class="flex flex-col items-center p-2">
        <i class="fa-solid fa-calendar text-xl mb-1"></i>
        <span class="text-xs">Calendar</span>
      </button>
      <button id="navTrash" class="flex flex-col items-center p-2">
        <i class="fa-solid fa-trash text-xl mb-1"></i>
        <span class="text-xs">Trash</span>
      </button>
    </div>
  </nav>

  <!-- Add chooser -->
  <div id="addModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="card w-full max-w-md mx-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold">Add New</h3>
        <button onclick="hideAddModal()" class="text-gray-500">
          <i class="fa-solid fa-xmark text-xl"></i>
        </button>
      </div>
      <div class="space-y-3">
        <button onclick="showPropertyForm()" class="w-full btn btn-primary">
          <i class="fa-solid fa-building mr-2"></i>Add Property
        </button>
        <button onclick="showContactForm()" class="w-full btn btn-blue">
          <i class="fa-solid fa-user mr-2"></i>Add Contact
        </button>
      </div>
    </div>
  </div>

  <!-- Property form -->
  <div id="propertyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="card w-full max-w-md mx-4 max-h-[80vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold">Add Property</h3>
        <button onclick="hidePropertyForm()" class="text-gray-500">
          <i class="fa-solid fa-xmark text-xl"></i>
        </button>
      </div>
      <form onsubmit="submitProperty(event)" class="space-y-4">
        <input type="text" id="propAddress" placeholder="Property Address" required
               class="w-full px-4 py-3 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600">
        <select id="propType" required
                class="w-full px-4 py-3 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600">
          <option value="">Property Type</option>
          <option value="house">House</option>
          <option value="apartment">Apartment</option>
          <option value="townhouse">Townhouse</option>
          <option value="unit">Unit</option>
        </select>
        <div class="grid grid-cols-3 gap-2">
          <input type="number" id="propBeds" placeholder="Beds" min="0" step="1" required
                 class="px-3 py-3 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600">
          <input type="number" id="propBaths" placeholder="Baths" min="0" step="1" required
                 class="px-3 py-3 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600">
          <input type="number" id="propCars" placeholder="Cars" min="0" step="1" required
                 class="px-3 py-3 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600">
        </div>
        <input type="text" id="propPrice" inputmode="decimal" placeholder="Price e.g. 750000" required
               class="w-full px-4 py-3 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600">
        <select id="propStatus" required class="w-full px-4 py-3 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600">
          <option value="">Status</option>
          <option value="Listed">Listed</option>
          <option value="Under Offer">Under Offer</option>
          <option value="Sold">Sold</option>
          <option value="Off-market">Off-market</option>
        </select>
        <textarea id="propNotes" placeholder="Notes (open home, vendor situation, agent comments…)" rows="3"
                  class="w-full px-4 py-3 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600"></textarea>
        <button type="submit" class="w-full btn btn-primary">Save</button>
      </form>
    </div>
  </div>

  <!-- Contact form -->
  <div id="contactModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="card w-full max-w-md mx-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold">Add Contact</h3>
        <button onclick="hideContactForm()" class="text-gray-500">
          <i class="fa-solid fa-xmark text-xl"></i>
        </button>
      </div>
      <form onsubmit="submitContact(event)" class="space-y-4">
        <input type="text" id="contactName" placeholder="Full Name" required
               class="w-full px-4 py-3 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600">
        <input type="email" id="contactEmail" placeholder="Email"
               class="w-full px-4 py-3 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600">
        <input type="tel" id="contactPhone" placeholder="Phone"
               class="w-full px-4 py-3 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600">
        <select id="contactType" required
                class="w-full px-4 py-3 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600">
          <option value="">Contact Type</option>
          <option value="buyer">Buyer</option>
          <option value="seller">Seller</option>
          <option value="tenant">Tenant</option>
          <option value="investor">Investor</option>
        </select>
        <select id="contactStage" required class="w-full px-4 py-3 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600">
          <option value="">Stage</option>
          <option value="New">New</option>
          <option value="Qualified">Qualified</option>
          <option value="Inspection">Inspection</option>
          <option value="Offer">Offer</option>
          <option value="Won">Won</option>
          <option value="Lost">Lost</option>
        </select>
        <textarea id="contactNotes" placeholder="Notes (budget, preferences, follow-ups…)" rows="3"
                  class="w-full px-4 py-3 text-base border rounded-lg dark:bg-gray-700 dark:border-gray-600"></textarea>
        <button type="submit" class="w-full btn btn-blue">Save</button>
      </form>
    </div>
  </div>

  <!-- Event modal -->
  <div id="eventModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="card w-full max-w-md mx-4">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-lg font-bold">Add Calendar Event</h3>
        <button onclick="closeEventModal()" class="text-gray-500"><i class="fa-solid fa-xmark text-xl"></i></button>
      </div>
      <form onsubmit="saveEvent(event)" class="space-y-3">
        <input type="date" id="evDate" required class="w-full px-3 py-2 border rounded dark:bg-gray-700 dark:border-gray-600">
        <input type="time" id="evTime" class="w-full px-3 py-2 border rounded dark:bg-gray-700 dark:border-gray-600">
        <input type="text" id="evTitle" placeholder="Title" required class="w-full px-3 py-2 border rounded dark:bg-gray-700 dark:border-gray-600">
        <textarea id="evNotes" placeholder="Notes" rows="3" class="w-full px-3 py-2 border rounded dark:bg-gray-700 dark:border-gray-600"></textarea>
        <button type="submit" class="w-full btn btn-primary">Save</button>
      </form>
    </div>
  </div>

  <!-- ===== Core App Script (localStorage + CSV + UI + Tabs + Search/Sort + Quick Actions + Trash + Calendar) ===== -->
  <script>
    // Dark mode
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const savedDark = localStorage.getItem('crm_dark');
    if ((savedDark === '1') || (savedDark === null && prefersDark)) {
      document.documentElement.classList.add('dark');
    }
    document.getElementById('darkToggle').addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
      localStorage.setItem('crm_dark', document.documentElement.classList.contains('dark') ? '1' : '0');
    });

    // Data
    let properties = JSON.parse(localStorage.getItem('properties') || '[]');
    let contacts   = JSON.parse(localStorage.getItem('contacts')   || '[]');
    let events     = JSON.parse(localStorage.getItem('events')     || '[]');
    let editingPropertyId = null;
    let editingContactId  = null;

    // Dirty flag for auto-sync
    let dirty = false;
    function markDirty(){ dirty = true; setStatus && setStatus('Changes pending…'); }

    // State (tabs, filters)
    let currentTab = localStorage.getItem('crm_tab') || 'dashboard';
    let searchTerm = '';
    let propSort = localStorage.getItem('crm_prop_sort') || 'newest';
    let contactSort = localStorage.getItem('crm_contact_sort') || 'newest';
    let viewingTrashOf = null; // 'properties' or 'contacts' for dashboard quick toggle

    // Utils
    const esc = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const fmtAUD = new Intl.NumberFormat('en-AU', { style: 'currency', currency: 'AUD' });
    const toMoney = v => { const n = Number(String(v).replace(/[^0-9.]/g,'')); return isNaN(n) ? '' : fmtAUD.format(n); };
    const statusEl = document.getElementById('syncStatus');
    const setStatus = (txt) => { statusEl.textContent = txt; statusEl.classList.remove('hidden'); setTimeout(()=>statusEl.classList.add('hidden'), 5000); };
    const stripPhone = p => (p||'').replace(/[^\d]/g,'');
    const encode = s => encodeURIComponent(s || '');

    // Search inputs
    const searchInput = document.getElementById('globalSearch');
    const searchMobile = document.getElementById('globalSearchMobile');
    [searchInput, searchMobile].forEach(el => el && el.addEventListener('input', e => { searchTerm = e.target.value.toLowerCase(); renderAll(); }));

    // Sort controls
    function hookSort(id, key, storeKey) {
      const el = document.getElementById(id);
      if (!el) return;
      el.value = key;
      el.addEventListener('change', () => {
        const v = el.value;
        if (storeKey === 'crm_prop_sort') { propSort = v; localStorage.setItem(storeKey, v); }
        else { contactSort = v; localStorage.setItem(storeKey, v); }
        renderAll();
      });
    }
    hookSort('propSort', propSort, 'crm_prop_sort');
    hookSort('contactSort', contactSort, 'crm_contact_sort');
    hookSort('propSortMobile', propSort, 'crm_prop_sort');
    hookSort('contactSortMobile', contactSort, 'crm_contact_sort');

    // Tabs
    const tabs = {
      dashboard: document.getElementById('dashboardSection'),
      propsOnly: document.getElementById('onlyProperties'),
      contactsOnly: document.getElementById('onlyContacts'),
      calendar: document.getElementById('calendarSection'),
      trash: document.getElementById('trashSection')
    };
    const navs = {
      dashboard: document.getElementById('navDashboard'),
      propsOnly: document.getElementById('navProperties'),
      contactsOnly: document.getElementById('navContacts'),
      calendar: document.getElementById('navCalendar'),
      trash: document.getElementById('navTrash')
    };
    function setTab(tab) {
      currentTab = tab;
      localStorage.setItem('crm_tab', tab);
      for (const k in tabs) tabs[k].classList.toggle('hidden', k !== tab);
      for (const k in navs) navs[k].classList.toggle('tab-active', k === tab);
      renderAll();
      if (tab === 'calendar') renderCalendar();
    }
    navs.dashboard.addEventListener('click', ()=> setTab('dashboard'));
    navs.propsOnly.addEventListener('click', ()=> setTab('propsOnly'));
    navs.contactsOnly.addEventListener('click', ()=> setTab('contactsOnly'));
    navs.calendar.addEventListener('click', ()=> setTab('calendar'));
    navs.trash.addEventListener('click', ()=> setTab('trash'));
    setTab(currentTab); // init

    // CSV helpers
    function escapeCSV(val) { if (val==null) return ''; const s=String(val); return /[",\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s; }
    function arrayToCSV(rows) { return rows.map(r => r.map(escapeCSV).join(',')).join('\n'); }
    function parseCSV(text) {
      const rows = []; let row = [], cur = '', inQ = false;
      for (let i=0;i<text.length;i++){ const ch=text[i], nx=text[i+1];
        if(inQ){ if(ch==='"'&&nx==='"'){cur+='"';i++;} else if(ch==='"'){inQ=false;} else {cur+=ch;} }
        else { if(ch==='"'){inQ=true;} else if(ch===','){row.push(cur);cur='';}
               else if(ch==='\n'||ch==='\r'){ if(ch==='\r'&&nx==='\n') i++; row.push(cur); rows.push(row); row=[]; cur='';}
               else {cur+=ch;} }
      }
      if(cur.length||row.length){ row.push(cur); rows.push(row); }
      return rows;
    }

    // Modals
    function showAddModal(){ const m=document.getElementById('addModal'); m.classList.remove('hidden'); m.classList.add('flex'); }
    function hideAddModal(){ const m=document.getElementById('addModal'); m.classList.add('hidden'); m.classList.remove('flex'); }

    function showPropertyForm(id=null){
      hideAddModal(); editingPropertyId=id;
      const modal=document.getElementById('propertyModal'); modal.classList.remove('hidden'); modal.classList.add('flex');
      const btn=modal.querySelector('button[type="submit"]'); const title=modal.querySelector('h3');
      if(id){ const p=properties.find(x=>x.id===id);
        propAddress.value=p.address; propType.value=p.type; propBeds.value=p.bedrooms; propBaths.value=p.bathrooms; propCars.value=p.carSpaces; propPrice.value=p.price; propStatus.value=p.status||''; propNotes.value=p.notes||'';
        btn.textContent='Save'; title.textContent='Edit Property';
      } else { propAddress.value=''; propType.value=''; propBeds.value=''; propBaths.value=''; propCars.value=''; propPrice.value=''; propStatus.value=''; propNotes.value='';
        btn.textContent='Save'; title.textContent='Add Property'; }
    }
    function hidePropertyForm(){ const m=document.getElementById('propertyModal'); m.classList.add('hidden'); m.classList.remove('flex'); editingPropertyId=null; }

    function showContactForm(id=null){
      hideAddModal(); editingContactId=id;
      const modal=document.getElementById('contactModal'); modal.classList.remove('hidden'); modal.classList.add('flex');
      const btn=modal.querySelector('button[type="submit"]'); const title=modal.querySelector('h3');
      if(id){ const c=contacts.find(x=>x.id===id);
        contactName.value=c.name||''; contactEmail.value=c.email||''; contactPhone.value=c.phone||''; contactType.value=c.type||''; contactStage.value=c.stage||''; contactNotes.value=c.notes||'';
        btn.textContent='Save'; title.textContent='Edit Contact';
      } else { contactName.value=''; contactEmail.value=''; contactPhone.value=''; contactType.value=''; contactStage.value=''; contactNotes.value='';
        btn.textContent='Save'; title.textContent='Add Contact'; }
    }
    function hideContactForm(){ const m=document.getElementById('contactModal'); m.classList.add('hidden'); m.classList.remove('flex'); editingContactId=null; }

    // Submit handlers
    function submitProperty(e){
      e.preventDefault();
      const payload={ address:propAddress.value, type:propType.value, bedrooms:propBeds.value, bathrooms:propBaths.value, carSpaces:propCars.value, price:propPrice.value, status:propStatus.value, notes:propNotes.value };
      if(editingPropertyId){ properties=properties.map(p=>p.id===editingPropertyId?{...p,...payload}:p); showNotification('Property saved'); }
      else { properties.push({ id:Date.now(), ...payload, createdAt:new Date().toLocaleDateString(), isTrashed:false, trashedAt:'' }); showNotification('Property added'); }
      localStorage.setItem('properties', JSON.stringify(properties));
      markDirty();
      renderAll(); hidePropertyForm(); e.target.reset(); editingPropertyId=null;
    }
    function submitContact(e){
      e.preventDefault();
      const payload={ name:contactName.value, email:contactEmail.value, phone:contactPhone.value, type:contactType.value, stage:contactStage.value, notes:contactNotes.value };
      if(editingContactId){ contacts=contacts.map(c=>c.id===editingContactId?{...c,...payload}:c); showNotification('Contact saved'); }
      else { contacts.push({ id:Date.now(), ...payload, createdAt:new Date().toLocaleDateString(), isTrashed:false, trashedAt:'' }); showNotification('Contact added'); }
      localStorage.setItem('contacts', JSON.stringify(contacts));
      markDirty();
      renderAll(); hideContactForm(); e.target.reset(); editingContactId=null;
    }

    // Delete (now soft-delete with confirm)
    function trashProperty(id){
      if(!confirm('Move this property to Trash?')) return;
      properties=properties.map(p=> p.id===id? {...p, isTrashed:true, trashedAt:new Date().toISOString()} : p);
      localStorage.setItem('properties', JSON.stringify(properties)); markDirty(); renderAll(); showNotification('Moved to Trash');
    }
    function trashContact(id){
      if(!confirm('Move this contact to Trash?')) return;
      contacts=contacts.map(c=> c.id===id? {...c, isTrashed:true, trashedAt:new Date().toISOString()} : c);
      localStorage.setItem('contacts', JSON.stringify(contacts)); markDirty(); renderAll(); showNotification('Moved to Trash');
    }
    function restoreProperty(id){
      properties=properties.map(p=> p.id===id? {...p, isTrashed:false, trashedAt:''} : p);
      localStorage.setItem('properties', JSON.stringify(properties)); markDirty(); renderAll(); showNotification('Restored');
    }
    function restoreContact(id){
      contacts=contacts.map(c=> c.id===id? {...c, isTrashed:false, trashedAt:''} : c);
      localStorage.setItem('contacts', JSON.stringify(contacts)); markDirty(); renderAll(); showNotification('Restored');
    }
    function deletePropertyForever(id){
      if(!confirm('Permanently delete this property? This cannot be undone.')) return;
      properties=properties.filter(p=>p.id!==id);
      localStorage.setItem('properties', JSON.stringify(properties)); markDirty(); renderAll(); showNotification('Deleted permanently','bg-red-600');
    }
    function deleteContactForever(id){
      if(!confirm('Permanently delete this contact? This cannot be undone.')) return;
      contacts=contacts.filter(c=>c.id!==id);
      localStorage.setItem('contacts', JSON.stringify(contacts)); markDirty(); renderAll(); showNotification('Deleted permanently','bg-red-600');
    }

    // Filtering + sorting helpers (ignore trashed unless in Trash tab)
    function filterProps(list){
      const base = currentTab==='trash' || viewingTrashOf==='properties' ? list.filter(p=>p.isTrashed) : list.filter(p=>!p.isTrashed);
      if(!searchTerm) return base;
      return base.filter(p=>{
        const s = `${p.address} ${p.type} ${p.bedrooms} ${p.bathrooms} ${p.carSpaces} ${p.price} ${p.createdAt||''} ${p.notes||''} ${p.status||''}`.toLowerCase();
        return s.includes(searchTerm);
      });
    }
    function sortProps(list){
      const arr = [...list];
      if (propSort==='price') arr.sort((a,b)=> (Number(b.price||0))-(Number(a.price||0)));
      else if (propSort==='beds') arr.sort((a,b)=> (Number(b.bedrooms||0))-(Number(a.bedrooms||0)));
      else arr.sort((a,b)=> (Number(b.id)-Number(a.id))); // newest
      return arr;
    }
    function filterContacts(list){
      const base = currentTab==='trash' || viewingTrashOf==='contacts' ? list.filter(c=>c.isTrashed) : list.filter(c=>!c.isTrashed);
      if(!searchTerm) return base;
      return base.filter(c=>{
        const s = `${c.name} ${c.email||''} ${c.phone||''} ${c.type} ${c.stage||''} ${c.createdAt||''} ${c.notes||''}`.toLowerCase();
        return s.includes(searchTerm);
      });
    }
    function sortContacts(list){
      const arr = [...list];
      if (contactSort==='name') arr.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
      else arr.sort((a,b)=> (Number(b.id)-Number(a.id))); // newest
      return arr;
    }

    // Quick actions
    function mapUrl(address){ return `https://www.google.com/maps/search/?api=1&query=${encode(address)}`; }
    async function copyText(t){ try{ await navigator.clipboard.writeText(t); showNotification('Copied to clipboard'); }catch(e){ showNotification('Copy failed','bg-red-600'); } }
    function mailtoProperty(p){
      const subject = encode(`Property: ${p.address}`);
      const body = encode(`Address: ${p.address}\nType: ${p.type}\nBeds/Baths/Cars: ${p.bedrooms}/${p.bathrooms}/${p.carSpaces}\nPrice: ${p.price}\nStatus: ${p.status||''}\nNotes:\n${p.notes||''}`);
      return `mailto:?subject=${subject}&body=${body}`;
    }
    function waLink(phone, text){ const num = (phone||'').replace(/[^\d]/g,''); return num? `https://wa.me/${num}?text=${encode(text||'')}` : '#'; }

    // Badges
    function statusBadge(status){
      if(status==='Listed') return `<span class="badge badge-blue">${esc(status)}</span>`;
      if(status==='Under Offer') return `<span class="badge badge-orange">${esc(status)}</span>`;
      if(status==='Sold') return `<span class="badge badge-green">${esc(status)}</span>`;
      return `<span class="badge badge-gray">${esc(status||'Unknown')}</span>`;
    }
    function stageBadge(stage){
      const map={New:'badge-gray',Qualified:'badge-blue',Inspection:'badge-purple',Offer:'badge-orange',Won:'badge-green',Lost:'badge-red'};
      const cls = map[stage]||'badge-gray';
      return `<span class="badge ${cls}">${esc(stage||'')}</span>`;
    }

    // Renderers
    function renderPropertiesTo(containerId, list){
      const container=document.getElementById(containerId);
      if(!list.length){ container.innerHTML='<p class="text-gray-500 text-center py-8">No properties found.</p>'; return; }
      container.innerHTML = list.map(p=>`
        <div class="card">
          <div class="flex justify-between items-start mb-2">
            <h3 class="font-semibold">${esc(p.address)}</h3>
            <div class="flex gap-2 items-center">${statusBadge(p.status)}${p.isTrashed?'<span class="badge badge-red">Trashed</span>':''}</div>
          </div>
          <div class="flex items-center space-x-4 text-sm text-gray-600 dark:text-gray-400 mb-2">
            <span><i class="fa-solid fa-building mr-1"></i>${esc(p.type)}</span>
            <span><i class="fa-solid fa-bed mr-1"></i>${esc(p.bedrooms)}</span>
            <span><i class="fa-solid fa-bath mr-1"></i>${esc(p.bathrooms)}</span>
            <span><i class="fa-solid fa-car mr-1"></i>${esc(p.carSpaces)}</span>
          </div>
          <div class="text-sm text-gray-700 dark:text-gray-300 mb-2">
            ${p.notes ? `<p><i class="fa-regular fa-note-sticky mr-2"></i>${esc(p.notes)}</p>` : ''}
          </div>
          <div class="flex justify-between items-center">
            <span class="font-bold text-primary">${toMoney(p.price) || esc(p.price)}</span>
            <span class="text-xs text-gray-500">${esc(p.createdAt||'')}</span>
          </div>
          <div class="flex flex-wrap gap-2 mt-3">
            ${p.isTrashed
              ? `<button class="btn btn-blue" onclick="restoreProperty(${p.id})">Restore</button>
                 <button class="btn btn-red" onclick="deletePropertyForever(${p.id})">Delete forever</button>`
              : `<button class="btn btn-blue" onclick="showPropertyForm(${p.id})">Edit</button>
                 <button class="btn btn-red" onclick="trashProperty(${p.id})">Move to Trash</button>
                 <a class="btn btn-ghost" href="${mapUrl(p.address)}" target="_blank" rel="noopener">Open in Maps</a>
                 <button class="btn btn-ghost" onclick="copyText('${esc(p.address).replace(/'/g, "\\'")}')">Copy address</button>
                 <a class="btn btn-ghost" href="${mailtoProperty(p)}">Share via Email</a>`}
          </div>
        </div>
      `).join('');
    }
    function renderContactsTo(containerId, list){
      const container=document.getElementById(containerId);
      if(!list.length){ container.innerHTML='<p class="text-gray-500 text-center py-8">No contacts found.</p>'; return; }
      container.innerHTML = list.map(c=>`
        <div class="card">
          <div class="flex justify-between items-start mb-2">
            <h3 class="font-semibold">${esc(c.name)}</h3>
            <div class="flex gap-2 items-center">${stageBadge(c.stage)}${c.isTrashed?'<span class="badge badge-red">Trashed</span>':''}</div>
          </div>
          <div class="space-y-1 text-sm text-gray-600 dark:text-gray-400">
            ${c.email ? `<p><i class="fa-solid fa-envelope mr-2"></i>${esc(c.email)}</p>` : ''}
            ${c.phone ? `<p><i class="fa-solid fa-phone mr-2"></i>${esc(c.phone)}</p>` : ''}
            ${c.notes ? `<p><i class="fa-regular fa-note-sticky mr-2"></i>${esc(c.notes)}</p>` : ''}
          </div>
          <div class="flex justify-between items-center mt-2">
            <span class="text-xs text-gray-500">${esc(c.createdAt||'')}</span>
            <div class="flex flex-wrap gap-2">
              ${c.isTrashed
                ? `<button class="btn btn-blue" onclick="restoreContact(${c.id})">Restore</button>
                   <button class="btn btn-red" onclick="deleteContactForever(${c.id})">Delete forever</button>`
                : `${c.phone ? `<a class="btn btn-ghost" href="tel:${stripPhone(c.phone)}">Call</a>` : ''}
                   ${c.email ? `<a class="btn btn-ghost" href="mailto:${encode(c.email)}?subject=${encode('Hello ' + (c.name||''))}">Email</a>` : ''}
                   ${c.phone ? `<a class="btn btn-ghost" target="_blank" rel="noopener" href="${waLink(c.phone, 'Hi ' + (c.name||''))}">WhatsApp</a>` : ''}
                   <button class="btn btn-blue" onclick="showContactForm(${c.id})">Edit</button>
                   <button class="btn btn-red" onclick="trashContact(${c.id})">Move to Trash</button>`}
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderAll(){
      // Counts (exclude trash in dashboard)
      document.getElementById('propertyCount').textContent = properties.filter(p=>!p.isTrashed).length;
      document.getElementById('contactCount').textContent  = contacts.filter(c=>!c.isTrashed).length;

      // Dashboard lists (recent, non-trashed or trashed if toggled)
      const pDash = sortProps(filterProps(properties)).slice(0, 10);
      const cDash = sortContacts(filterContacts(contacts)).slice(0, 10);
      renderPropertiesTo('propertiesList', pDash);
      renderContactsTo('contactsList', cDash);

      // Only tabs
      renderPropertiesTo('propertiesListOnly', sortProps(filterProps(properties)));
      renderContactsTo('contactsListOnly', sortContacts(filterContacts(contacts)));

      // Trash tab
      if (currentTab==='trash') {
        renderPropertiesTo('trashProps', properties.filter(p=>p.isTrashed));
        renderContactsTo('trashContacts', contacts.filter(c=>c.isTrashed));
      }
    }

    function showNotification(message, color='bg-green-500'){
      const n=document.createElement('div'); n.className=`fixed top-4 right-4 ${color} text-white px-4 py-2 rounded-lg z-50 shadow`; n.textContent=message;
      document.body.appendChild(n); setTimeout(()=>n.remove(), 2500);
    }

    // Quick dashboard trash toggles
    function toggleTrashView(which){
      viewingTrashOf = viewingTrashOf===which ? null : which; renderAll();
    }

    // CSV export/import (with notes + status + trash flags)
    function exportPropertiesCSV(){
      const headers=['id','address','type','bedrooms','bathrooms','carspaces','price','createdat','notes','status','istrashed','trashedat'];
      const rows=[headers].concat(properties.map(p=>[p.id,p.address,p.type,p.bedrooms,p.bathrooms,p.carSpaces,p.price,p.createdAt||'',p.notes||'',p.status||'',p.isTrashed?'TRUE':'',p.trashedAt||'']));
      downloadFile('properties.csv', arrayToCSV(rows));
    }
    function exportContactsCSV(){
      const headers=['id','name','email','phone','type','createdat','notes','stage','istrashed','trashedat'];
      const rows=[headers].concat(contacts.map(c=>[c.id,c.name,c.email||'',c.phone||'',c.type,c.createdAt||'',c.notes||'',c.stage||'',c.isTrashed?'TRUE':'',c.trashedAt||'']));
      downloadFile('contacts.csv', arrayToCSV(rows));
    }
    function downloadFile(filename, text){
      const blob=new Blob([text], {type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},0);
    }
    function handleImportProps(file){
      if(!file) return; const r=new FileReader();
      r.onload=()=>{ try{
          const rows=parseCSV(r.result.trim()); if(!rows.length) throw new Error('Empty CSV');
          const header=rows.shift().map(h=>h.toLowerCase()); const idx=n=>header.indexOf(n);
          const need=['id','address','type','bedrooms','bathrooms','carspaces','price','createdat','notes','status','istrashed','trashedat']; const miss=need.filter(k=>idx(k)===-1);
          if(miss.length) throw new Error('Missing columns: '+miss.join(', '));
          const imported=rows.map(v=>({ id:Number(v[idx('id')])||Date.now()+Math.floor(Math.random()*1000),
            address:v[idx('address')]||'', type:v[idx('type')]||'', bedrooms:v[idx('bedrooms')]||'', bathrooms:v[idx('bathrooms')]||'',
            carSpaces:v[idx('carspaces')]||'', price:v[idx('price')]||'', createdAt:v[idx('createdat')]||'', notes:v[idx('notes')]||'',
            status:v[idx('status')]||'', isTrashed:/true/i.test(v[idx('istrashed')]||''), trashedAt:v[idx('trashedat')]||'' }));
          const map=new Map(properties.map(p=>[p.id,p])); imported.forEach(p=>map.set(p.id,{...(map.get(p.id)||{}),...p})); properties=[...map.values()];
          localStorage.setItem('properties', JSON.stringify(properties)); markDirty(); renderAll(); showNotification('Properties imported');
        }catch(e){ console.error(e); showNotification('Import failed. Check CSV columns.','bg-red-600'); }
        finally{ document.getElementById('importPropsInput').value=''; }
      }; r.readAsText(file);
    }
    function handleImportContacts(file){
      if(!file) return; const r=new FileReader();
      r.onload=()=>{ try{
          const rows=parseCSV(r.result.trim()); if(!rows.length) throw new Error('Empty CSV');
          const header=rows.shift().map(h=>h.toLowerCase()); const idx=n=>header.indexOf(n);
          const need=['id','name','email','phone','type','createdat','notes','stage','istrashed','trashedat']; const miss=need.filter(k=>idx(k)===-1);
          if(miss.length) throw new Error('Missing columns: '+miss.join(', '));
          const imported=rows.map(v=>({ id:Number(v[idx('id')])||Date.now()+Math.floor(Math.random()*1000), name:v[idx('name')]||'', email:v[idx('email')]||'', phone:v[idx('phone')]||'', type:v[idx('type')]||'', createdAt:v[idx('createdat')]||'', notes:v[idx('notes')]||'', stage:v[idx('stage')]||'', isTrashed:/true/i.test(v[idx('istrashed')]||''), trashedAt:v[idx('trashedat')]||'' }));
          const map=new Map(contacts.map(c=>[c.id,c])); imported.forEach(c=>map.set(c.id,{...(map.get(c.id)||{}),...c})); contacts=[...map.values()];
          localStorage.setItem('contacts', JSON.stringify(contacts)); markDirty(); renderAll(); showNotification('Contacts imported');
        }catch(e){ console.error(e); showNotification('Import failed. Check CSV columns.','bg-red-600'); }
        finally{ document.getElementById('importContactsInput').value=''; }
      }; r.readAsText(file);
    }

    // Calendar (month view: supports now → +30 years)
    const calTitle = document.getElementById('calTitle');
    const calGrid  = document.getElementById('calGrid');
    let calRef = new Date(); // current anchor month
    const today = new Date();
    function clampToWindow(d){
      const start = new Date();
      start.setHours(0,0,0,0);
      const end = new Date();
      end.setFullYear(end.getFullYear()+30);
      if(d < start) return new Date(start);
      if(d > end) return new Date(end);
      return d;
    }
    function startOfMonth(d){ const x=new Date(d); x.setDate(1); x.setHours(0,0,0,0); return x; }
    function daysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }
    function renderCalendar(){
      const d = clampToWindow(calRef);
      const y = d.getFullYear(), m = d.getMonth();
      calTitle.textContent = d.toLocaleString(undefined, { month:'long', year:'numeric' });
      calGrid.innerHTML = '';
      const first = startOfMonth(d);
      const pad = first.getDay(); // 0=Sun
      const total = daysInMonth(y,m);

      // leading blanks
      for(let i=0;i<pad;i++){ const cell=document.createElement('div'); cell.className='cal-cell'; calGrid.appendChild(cell); }

      for(let day=1; day<=total; day++){
        const cell=document.createElement('div'); cell.className='cal-cell';
        const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const isToday = (y===today.getFullYear() && m===today.getMonth() && day===today.getDate());
        if(isToday) cell.classList.add('cal-today');
        cell.innerHTML = `<div class="text-xs text-gray-500">${day}</div><div id="ev-${dateStr}"></div>`;
        cell.addEventListener('dblclick', ()=> openEventModal(dateStr));
        calGrid.appendChild(cell);

        // render events for this day
        const dayEvents = events.filter(ev => ev.date === dateStr);
        const host = cell.querySelector(`#ev-${dateStr}`);
        dayEvents.slice(0,4).forEach(ev=>{
          const div=document.createElement('div'); div.className='cal-event'; div.textContent = (ev.time? ev.time+' · ' : '') + ev.title;
          host.appendChild(div);
        });
        if (dayEvents.length>4){
          const more=document.createElement('div'); more.className='cal-event'; more.textContent = `+${dayEvents.length-4} more`;
          host.appendChild(more);
        }
      }
    }
    function prevMonth(){ calRef.setMonth(calRef.getMonth()-1); renderCalendar(); }
    function nextMonth(){ calRef.setMonth(calRef.getMonth()+1); renderCalendar(); }
    function goToday(){ calRef = new Date(); renderCalendar(); }

    function openEventModal(dateStr){
      const modal=document.getElementById('eventModal'); modal.classList.remove('hidden'); modal.classList.add('flex');
      const d = dateStr || new Date().toISOString().slice(0,10);
      evDate.value = d; evTime.value=''; evTitle.value=''; evNotes.value='';
    }
    function closeEventModal(){ const m=document.getElementById('eventModal'); m.classList.add('hidden'); m.classList.remove('flex'); }
    function saveEvent(e){
      e.preventDefault();
      const ev = { id: Date.now(), date: evDate.value, time: evTime.value, title: evTitle.value, notes: evNotes.value };
      events.push(ev);
      localStorage.setItem('events', JSON.stringify(events));
      closeEventModal();
      showNotification('Event saved');
      if(currentTab==='calendar') renderCalendar();
    }

    // Initial render
    renderAll();
    if(currentTab==='calendar') renderCalendar();
  </script>

  <!-- ===== Google API loader ===== -->
  <script src="https://apis.google.com/js/api.js"></script>

  <!-- ===== Google Sheets Sync (OAuth + read/write + auto-sync) ===== -->
  <script>
    /* === CONFIG (yours) === */
    const GAPI_API_KEY   = 'AIzaSyCX7yThc3WManWS2EJcc0zkKa6o01T1dec';
    const GAPI_CLIENT_ID = '836099334681-tmb272ie85u0qdb080nb97bvcgtvuvvid.apps.googleusercontent.com';
    const SHEET_ID       = '1Oumn0bFkkHvRrETlNEi4u4eM63DPfkkRuwE05gpWdFM';
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
    const DISCOVERY_DOCS = ['https://sheets.googleapis.com/$discovery/rest?version=v4'];

    // Add Sign in / Sync buttons to header
    (function addSyncButtons(){
      const hdr = document.querySelector('header .flex.items-center.justify-between');
      if (!hdr) return;
      const right = hdr.lastElementChild;

      const wrap = document.createElement('div');
      wrap.className = 'flex items-center gap-2';

      const signBtn = document.createElement('button');
      signBtn.id = 'gSignBtn';
      signBtn.className = 'btn btn-ghost';
      signBtn.textContent = 'Sign in';
      wrap.appendChild(signBtn);

      const pullBtn = document.createElement('button');
      pullBtn.id = 'pullBtn';
      pullBtn.className = 'btn btn-ghost';
      pullBtn.textContent = 'Sync ↓';
      pullBtn.disabled = true;
      wrap.appendChild(pullBtn);

      const pushBtn = document.createElement('button');
      pushBtn.id = 'pushBtn';
      pushBtn.className = 'btn btn-ghost';
      pushBtn.textContent = 'Sync ↑';
      pushBtn.disabled = true;
      wrap.appendChild(pushBtn);

      right.prepend(wrap);
    })();

    // Sheets helpers
    async function readSheet(rangeA1){
      const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SHEET_ID, range: rangeA1 });
      return res.result.values || [];
    }
    async function writeSheet(rangeA1, values){
      return gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: SHEET_ID, range: rangeA1, valueInputOption: 'RAW', resource: { values }
      });
    }
    async function clearRange(rangeA1){
      return gapi.client.sheets.spreadsheets.values.clear({ spreadsheetId: SHEET_ID, range: rangeA1 });
    }

    // Reusable pull/push (now with status + trash fields)
    async function pullFromSheets() {
      setStatus('Syncing ↓ from Sheets…');
      const props = await readSheet('Properties!A2:L'); // 12 cols
      const cons  = await readSheet('Contacts!A2:J');   // 10 cols
      properties = (props || []).map(r => ({
        id: Number(r[0]) || Date.now() + Math.floor(Math.random()*1000),
        address: r[1] || '', type: r[2] || '',
        bedrooms: r[3] || '', bathrooms: r[4] || '',
        carSpaces: r[5] || '', price: r[6] || '',
        createdAt: r[7] || '', notes: r[8] || '',
        status: r[9] || '',
        isTrashed: /true/i.test(r[10]||''),
        trashedAt: r[11] || ''
      }));
      contacts = (cons || []).map(r => ({
        id: Number(r[0]) || Date.now() + Math.floor(Math.random()*1000),
        name: r[1] || '', email: r[2] || '', phone: r[3] || '',
        type: r[4] || '', createdAt: r[5] || '', notes: r[6] || '',
        stage: r[7] || '',
        isTrashed: /true/i.test(r[8]||''),
        trashedAt: r[9] || ''
      }));
      localStorage.setItem('properties', JSON.stringify(properties));
      localStorage.setItem('contacts', JSON.stringify(contacts));
      renderAll();
      dirty = false; // pulled is clean
      setStatus('Synced just now');
      showNotification('Pulled from Google Sheets');
    }

    async function pushToSheets() {
      setStatus('Syncing ↑ to Sheets…');
      const propValues = (properties || []).map(p => [
        p.id, p.address || '', p.type || '', p.bedrooms || '',
        p.bathrooms || '', p.carSpaces || '', p.price || '', p.createdAt || '',
        p.notes || '', p.status || '', p.isTrashed ? 'TRUE' : '', p.trashedAt || ''
      ]);
      const conValues = (contacts || []).map(c => [
        c.id, c.name || '', c.email || '', c.phone || '', c.type || '', c.createdAt || '',
        c.notes || '', c.stage || '', c.isTrashed ? 'TRUE' : '', c.trashedAt || ''
      ]);
      await clearRange('Properties!A2:L');
      await clearRange('Contacts!A2:J');
      if (propValues.length) await writeSheet('Properties!A2', propValues);
      if (conValues.length)  await writeSheet('Contacts!A2',  conValues);
      dirty = false;
      setStatus('Synced just now');
      showNotification('Pushed to Google Sheets');
    }

    // Google API init + auto-sync
    function gapiInit() {
      gapi.load('client:auth2', async () => {
        await gapi.client.init({
          apiKey: GAPI_API_KEY,
          clientId: GAPI_CLIENT_ID,
          discoveryDocs: DISCOVERY_DOCS,
          scope: SCOPES
        });

        const auth    = gapi.auth2.getAuthInstance();
        const signBtn = document.getElementById('gSignBtn');
        const pullBtn = document.getElementById('pullBtn');
        const pushBtn = document.getElementById('pushBtn');

        function setAuthUI(signedIn){
          if (signBtn) signBtn.textContent = signedIn ? 'Sign out' : 'Sign in';
          if (pullBtn) pullBtn.disabled = !signedIn;
          if (pushBtn) pushBtn.disabled = !signedIn;
        }

        auth.isSignedIn.listen(async (signedIn) => {
          setAuthUI(signedIn);
          if (signedIn) {
            try { await pullFromSheets(); } catch(e){ console.error(e); setStatus('Sync error'); }
          }
        });

        setAuthUI(auth.isSignedIn.get());
        if (auth.isSignedIn.get()) {
          try { await pullFromSheets(); } catch(e){ console.error(e); setStatus('Sync error'); }
        }

        if (signBtn) signBtn.onclick = () => auth.isSignedIn.get() ? auth.signOut() : auth.signIn();
        if (pullBtn) pullBtn.onclick = async () => { try { await pullFromSheets(); } catch(e){ console.error(e); setStatus('Sync error'); showNotification('Pull failed (Sheets)','bg-red-600'); } };
        if (pushBtn) pushBtn.onclick = async () => { try { await pushToSheets(); } catch(e){ console.error(e); setStatus('Sync error'); showNotification('Push failed (Sheets)','bg-red-600'); } };

        // Auto-push every 2 minutes if there are pending changes
        setInterval(async () => {
          try {
            if (auth.isSignedIn.get() && dirty) await pushToSheets();
          } catch (e) { console.error(e); setStatus('Sync error'); }
        }, 120000);

        // Best-effort note on unload
        window.addEventListener('beforeunload', () => {
          if (auth.isSignedIn.get() && dirty) setStatus('Saving changes…');
        });
      });
    }
    gapiInit();
  </script>
</body>
</html>
